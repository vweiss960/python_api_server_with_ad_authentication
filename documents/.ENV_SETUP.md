# Environment Variables (.env) Setup Guide

## Overview

The project now uses a `.env` file to store environment variables for AD authentication testing. This is more convenient than setting environment variables manually each time.

## How It Works

The `ad_auth_test.py` utility automatically loads environment variables from the `.env` file in the project root directory when it runs.

### Location
- File: `.env` (in the root directory)
- Automatically loaded by: `tools/ad_auth_test.py`

## Quick Start

### 1. The .env file already exists with test credentials:

```
AD_PASSWORD=T3est123!!
JWT_SECRET=my_super_secret_jwt_string
```

### 2. Run the test utility (environment variables are loaded automatically):

```cmd
python tools/ad_auth_test.py --config config/config.test.yaml --username mtau --password "T3est123!!" --verbose
```

Or run the server:

```cmd
python -m src.main --config config/config.test.yaml
```

That's it! No need to manually set environment variables.

## Using Your Own Credentials

### For Your Own AD Server

Edit `.env` and update:

```
AD_PASSWORD=your_actual_ad_password
JWT_SECRET=your_secret_key
```

Then run as normal - the variables are loaded automatically.

### Generating a Strong JWT Secret

```bash
# On Linux/Mac:
openssl rand -hex 32

# On Windows PowerShell:
$bytes = New-Object Byte[] 32
[Security.Cryptography.RNGCryptoServiceProvider]::new().GetBytes($bytes)
[BitConverter]::ToString($bytes) -replace '-', ''
```

Example output: `c3a7f9b2e1d4c6a9f3e2b1d5c8a7f9e6b2d5c8a3f6e9b1c4d7a0e3f6b9c2e5`

Use this as your JWT_SECRET.

## Test Domain Credentials (mytestdomain.com)

The `.env` file comes pre-configured for testing with mytestdomain.com:

```
AD_PASSWORD=T3est123!!          # Admin user password
JWT_SECRET=my_super_secret_jwt_string  # Test JWT secret
```

### Test Users:

**Admin User (mtau):**
- Username: `mtau` (or `MTD\mtau` or `mtau@mytestdomain.com`)
- Password: `T3est123!!` (from .env)
- Groups: admin_users

**Read-Only User (bro):**
- Username: `bro` (or `MTD\bro` or `bro@mytestdomain.com`)
- Password: `T3est1234!!` (hardcoded for this user)
- Groups: ro_users

## Security Important!

⚠️ **DO NOT commit .env with production credentials to version control!**

### What's Protected:

- `.env` is in `.gitignore` - won't be committed to git
- Only the `.env.example` template is tracked in git
- Your actual `.env` with credentials stays local

### For Production:

1. Never put real passwords in `.env`
2. Use proper secrets management:
   - Azure Key Vault
   - AWS Secrets Manager
   - HashiCorp Vault
   - Environment variables set by deployment system
3. Keep `.env` files local-only during development

## Customizing the .env file

### Available Variables:

```
AD_PASSWORD          # AD service account password (required for LDAP)
JWT_SECRET          # Secret for signing JWT tokens (required)
```

### Adding More Variables:

You can add any variables you need:

```
AD_PASSWORD=my_password
JWT_SECRET=my_secret
MY_CUSTOM_VAR=custom_value
```

Then access them in Python:

```python
import os
from dotenv import load_dotenv

load_dotenv()
password = os.getenv('AD_PASSWORD')
secret = os.getenv('JWT_SECRET')
custom = os.getenv('MY_CUSTOM_VAR')
```

## Troubleshooting

### Problem: Environment variables not loading

**Check 1:** Verify `.env` file exists in project root:
```bash
ls -la .env
```

**Check 2:** Verify file format (no extra spaces around =):
```
# Wrong:
AD_PASSWORD = T3est123!!

# Correct:
AD_PASSWORD=T3est123!!
```

**Check 3:** Restart your terminal after modifying `.env`

### Problem: Changes to .env not taking effect

**Solution:** Restart your terminal/IDE to reload environment variables

### Problem: "AD_PASSWORD not found" error

**Check:** Make sure you're using `python-dotenv==1.0.0`:
```bash
pip list | grep dotenv
```

If not installed:
```bash
pip install python-dotenv==1.0.0
```

## File Comparison

### Before (without .env):

```cmd
set AD_PASSWORD=T3est123!!
set JWT_SECRET=my_super_secret_jwt_string
python tools/ad_auth_test.py --config config/config.test.yaml --username mtau --password "T3est123!!"
```

### After (with .env):

```cmd
python tools/ad_auth_test.py --config config/config.test.yaml --username mtau --password "T3est123!!"
```

Much simpler!

## Where Is This Used?

The `.env` file is automatically loaded by:

1. **tools/ad_auth_test.py** - AD testing utility
   - Loads .env automatically when run
   - Uses AD_PASSWORD and JWT_SECRET

2. **Can be used by src/main.py** - API server
   - Currently not set up to use .env
   - But can be added if needed

## Integration with src/main.py

If you want the API server to also load from `.env`:

```python
# At the top of src/main.py
from pathlib import Path
from dotenv import load_dotenv

# Load .env file
load_dotenv(Path(__file__).parent.parent / ".env")
```

Then config can reference environment variables:

```yaml
jwt:
  secret: ${JWT_SECRET}
```

## Recommended Workflow

1. Copy `.env.example` if it doesn't exist:
   ```bash
   cp .env.example .env
   ```

2. Edit `.env` with your credentials:
   ```bash
   # Edit with your editor
   nano .env  # or use your IDE
   ```

3. Never commit `.env` to git (already in .gitignore)

4. Share `.env.example` template with team, not actual `.env`

## More Information

- See [WINDOWS_ENV_QUICK_REFERENCE.md](WINDOWS_ENV_QUICK_REFERENCE.md) for other ways to set variables
- See [.env.example](.env.example) for the template
- See [README.md](README.md) for API documentation
